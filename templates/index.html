<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; max-width: 960px; margin: auto; }
        .accordion-button:not(.collapsed) { background-color: #e9ecef; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
<h1 class="mb-4">Web Analyzer</h1>

<form id="analyzeForm" class="mb-3 d-flex gap-2">
    <input type="text" id="urlInput" class="form-control" placeholder="Enter URL" required>
    <button type="submit" class="btn btn-primary">Analyze</button>
</form>

<button id="loadHistoryBtn" class="btn btn-outline-secondary mb-4">Show History</button>

<div id="result"></div>
<div id="history"></div>

<script>
    function renderResult(data) {
        const headings = Object.entries(data.headings || {})
            .map(([tag, count]) => `<li><strong>${tag.toUpperCase()}:</strong> ${count}</li>`).join('');

        document.getElementById('result').innerHTML = `
        <div class="accordion" id="analysisAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingInfo">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInfo">
                Analysis Summary
              </button>
            </h2>
            <div id="collapseInfo" class="accordion-collapse collapse show">
              <div class="accordion-body">
                <ul class="list-group">
                  <li class="list-group-item"><strong>Title:</strong> ${data.title}</li>
                  <li class="list-group-item"><strong>URL:</strong> ${data.url || ''}</li>
                  <li class="list-group-item"><strong>Status Code:</strong> ${data.statusCode}</li>
                  <li class="list-group-item"><strong>HTML Version:</strong> ${data.HTMLVersion}</li>
                  <li class="list-group-item"><strong>Internal Links:</strong> ${data.internalLinks}</li>
                  <li class="list-group-item"><strong>External Links:</strong> ${data.externalLinks}</li>
                  <li class="list-group-item"><strong>Inaccessible Links:</strong> ${data.inaccessible_links}</li>
                  <li class="list-group-item"><strong>Contains Login Form:</strong> ${data.hasLoginForm ? 'Yes' : 'No'}</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingHeadings">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHeadings">
                Headings Breakdown
              </button>
            </h2>
            <div id="collapseHeadings" class="accordion-collapse collapse">
              <div class="accordion-body">
                <ul>${headings}</ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    document.getElementById('analyzeForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const url = document.getElementById('urlInput').value;

        fetch('/api/v1/web-pages/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('result').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    renderResult(data);
                }
            })
            .catch(err => {
                document.getElementById('result').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            });
    });

    document.getElementById('loadHistoryBtn').addEventListener('click', function () {
        fetch('/api/v1/analyses/all')
            .then(res => res.json())
            .then(data => {
                const list = data.analyses || data;
                if (!Array.isArray(list)) {
                    document.getElementById('history').innerHTML = `<div class="alert alert-warning">Failed to load history</div>`;
                    return;
                }

                const rows = list.map(item => `
            <tr class="link" data-id="${item.id}" onclick="loadAnalysis(this.dataset.id)" style="cursor:pointer">
              <td>${item.url}</td>
              <td>${item.title}</td>
              <td>${new Date(item.timeRequested).toLocaleString()}</td>
            </tr>
          `).join('');

                document.getElementById('history').innerHTML = `
            <h2>History</h2>
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr><th>URL</th><th>Title</th><th>Requested At</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          `;
            })
            .catch(err => {
                document.getElementById('history').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            });
    });

    function loadAnalysis(id) {
        fetch('/api/v1/analyses/by-id?session-id=' + id)
            .then(res => res.json())
            .then(renderResult)
            .catch(err => {
                document.getElementById('result').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>